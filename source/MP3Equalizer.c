/*
 * MP3Equalizer.c
 *
 *  Created on: Mar 8, 2019
 *      Author: Santi
 */

#include "MP3Equalizer.h"
#include "MP3PlayerData.h"
#include <math.h>

#include <stdlib.h>

#define M_PI 3.1415926535897932384626433832795
#define FILTER_COEFFS		6
#define FILTER_STATE_VARS	4
#define FILTER_STAGES		3
#define FILTER_REM_LP		1

typedef struct
{
	q15_t coeff[FILTER_COEFFS * FILTER_STAGES];// b0, b1, b2, a1, a2
	q15_t varState[FILTER_STATE_VARS * FILTER_STAGES];//x_1, x_2, y_1, y_2;
}filter_t;

float equalizerCoeffs[2*EQ_MAX_DB/EQ_STEP_DB+1][EQ_BANDS][FILTER_COEFFS*FILTER_STAGES]=
{{{0.500000,0.000000,-0.965247,0.469577,0.920261,-0.429433,0.500000,0.000000,-0.984162,0.485172,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.878360,0.415459,0.749502,-0.320543,0.500000,0.000000,-0.947234,0.456492,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.571515,0.308354,0.299778,-0.172340,0.500000,0.000000,-0.821082,0.387271,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.962847,0.467372,0.920261,-0.429433,0.500000,0.000000,-0.983824,0.484788,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.871226,0.409777,0.749502,-0.320543,0.500000,0.000000,-0.946523,0.455360,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.554683,0.298013,0.299778,-0.172340,0.500000,0.000000,-0.821453,0.384519,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.960255,0.464998,0.920261,-0.429433,0.500000,0.000000,-0.983517,0.484434,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.863562,0.403721,0.749502,-0.320543,0.500000,0.000000,-0.945902,0.454312,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.536881,0.287313,0.299778,-0.172340,0.500000,0.000000,-0.822064,0.381983,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.957455,0.462441,0.920261,-0.429433,0.500000,0.000000,-0.983247,0.484117,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.855329,0.397274,0.749502,-0.320543,0.500000,0.000000,-0.945385,0.453364,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.518071,0.276283,0.299778,-0.172340,0.500000,0.000000,-0.822945,0.379703,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.954432,0.459691,0.920261,-0.429433,0.500000,0.000000,-0.983020,0.483842,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.846489,0.390421,0.749502,-0.320543,0.500000,0.000000,-0.944988,0.452534,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.498214,0.264963,0.299778,-0.172340,0.500000,0.000000,-0.824125,0.377717,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.951169,0.456735,0.920261,-0.429433,0.500000,0.000000,-0.982842,0.483616,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.837003,0.383150,0.749502,-0.320543,0.500000,0.000000,-0.944728,0.451838,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.477280,0.253401,0.299778,-0.172340,0.500000,0.000000,-0.825631,0.376068,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.947650,0.453561,0.920261,-0.429433,0.500000,0.000000,-0.982719,0.483445,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.826832,0.375453,0.749502,-0.320543,0.500000,0.000000,-0.944619,0.451295,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.455243,0.241661,0.299778,-0.172340,0.500000,0.000000,-0.827487,0.374792,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.943858,0.450159,0.920261,-0.429433,0.500000,0.000000,-0.982656,0.483334,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.815939,0.367327,0.749502,-0.320543,0.500000,0.000000,-0.944674,0.450919,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.432086,0.229815,0.299778,-0.172340,0.500000,0.000000,-0.829713,0.373925,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.939776,0.446519,0.920261,-0.429433,0.500000,0.000000,-0.982656,0.483288,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.804286,0.358772,0.749502,-0.320543,0.500000,0.000000,-0.944904,0.450723,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.407804,0.217950,0.299778,-0.172340,0.500000,0.000000,-0.832321,0.373496,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.935390,0.442632,0.920261,-0.429433,0.500000,0.000000,-0.982723,0.483308,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.791842,0.349797,0.749502,-0.320543,0.500000,0.000000,-0.945316,0.450718,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.382403,0.206161,0.299778,-0.172340,0.500000,0.000000,-0.835318,0.373526,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.930684,0.438491,0.920261,-0.429433,0.500000,0.000000,-0.982857,0.483398,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.778579,0.340417,0.749502,-0.320543,0.500000,0.000000,-0.945914,0.450909,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.355904,0.194555,0.299778,-0.172340,0.500000,0.000000,-0.838698,0.374027,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,-0.925645,0.434093,0.920261,-0.429433,0.500000,0.000000,-0.983059,0.483556,0.983325,-0.483781,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.764471,0.330656,0.749502,-0.320543,0.500000,0.000000,-0.946696,0.451297,0.947655,-0.451878,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,-0.328345,0.183244,0.299778,-0.172340,0.500000,0.000000,-0.842445,0.374999,0.846534,-0.376430,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},},
{{0.500000,0.000000,0.000000,0.000000,-0.000000,-0.000000,0.500000,0.000000,0.000000,0.000000,-0.000000,-0.000000,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,0.000000,0.000000,-0.000000,-0.000000,0.500000,0.000000,0.000000,0.000000,-0.000000,-0.000000,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},{0.500000,0.000000,0.000000,0.000000,-0.000000,-0.000000,0.500000,0.000000,0.000000,0.000000,-0.000000,-0.000000,0.081832,0.000000,0.163664,0.081832,0.316046,-0.183314},}
};


static filter_t filterBandsL[EQ_BANDS];
static filter_t filterBandsR[EQ_BANDS];
static arm_biquad_casd_df1_inst_q15 filterL;//[EQ_BANDS];
static arm_biquad_casd_df1_inst_q15 filterR;//[EQ_BANDS];
static q15_t filterCoeffs[EQ_BANDS*FILTER_COEFFS*(FILTER_STAGES-FILTER_REM_LP)];
static float freqBands[EQ_BANDS] = {134,774,4000};
static float qFactor[EQ_BANDS] = {0.05,1,0.9};
static int fs;

filter_t calcCoeffs(float f, float g, float q);

void setGains(int* gains)
{
	for(int i = 0; i < EQ_BANDS; i++)
	{
		//q15_t lastVars[4];
		filterBandsL[i] = calcCoeffs(freqBands[i], gains[i], qFactor[i]);
		filterBandsR[i] = filterBandsL[i];
		for(int j=0;j<FILTER_COEFFS*(FILTER_STAGES-FILTER_REM_LP);j++)
		{
			filterCoeffs[i*FILTER_COEFFS*(FILTER_STAGES-FILTER_REM_LP)+j]=filterBandsL[i].coeff[j];
		}
		//arm_biquad_cascade_df1_init_q15(filterL+i,FILTER_STAGES-FILTER_REM_LP,filterBandsL[i].coeff,filterBandsL[i].varState,1);
		//arm_biquad_cascade_df1_init_q15(filterR+i,FILTER_STAGES-FILTER_REM_LP,filterBandsR[i].coeff,filterBandsR[i].varState,1);
	}
	arm_biquad_cascade_df1_init_q15(&filterL,(FILTER_STAGES-FILTER_REM_LP)*EQ_BANDS,filterCoeffs,filterBandsL[0].varState,1);
	arm_biquad_cascade_df1_init_q15(&filterR,(FILTER_STAGES-FILTER_REM_LP)*EQ_BANDS,filterCoeffs,filterBandsR[0].varState,1);
}


void init(int fsample)
{
	fs = fsample;
	setGains(MP3PlayerData.equalizeBands);
}

void equalize(q15_t* input,unsigned short* output, int len, int dir)
{
	if(dir == 0)
	{
		arm_biquad_cascade_df1_q15(&filterL,(q15_t*)input,(q15_t*)output,len);

	}
	else
	{
		arm_biquad_cascade_df1_q15(&filterR,(q15_t*)input,(q15_t*)output,len);

	}
}

filter_t calcCoeffs(float f, float g, float q)
{
	filter_t filter;

	int gain=g+EQ_MAX_DB,band=0;
	for(int i=0;i<EQ_BANDS;i++)
		if(f==freqBands[i])
		{	band=i;break;}

	arm_float_to_q15(equalizerCoeffs[gain][band],filter.coeff,FILTER_COEFFS * FILTER_STAGES);

	return filter;
}

MP3Equalizer_ MP3Equalizer = {.init = init, .equalize = equalize, .setGains = setGains};

